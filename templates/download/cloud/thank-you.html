{% extends "download/_base_download.html" %}

{% block title %}Thank you | Download{% endblock %}
{% block extra_body_class %}download-thankyou{% endblock %}

{% block second_level_nav_items %}
{% include "templates/_nav_breadcrumb.html" with section_title="Download" subsection_title="Server for cloud" page_title="Thank you"  %}
{% endblock second_level_nav_items %}

{% block content %}
    <noscript>
        <meta http-equiv="refresh" content="3;url=http://releases.ubuntu.com/{{ request.GET.version }}/ubuntu-{{ request.GET.version }}-server-{{ request.GET.architecture.split|join:"+" }}.iso">
    </noscript>

    <div class="row row-hero no-border">
        <div class="eight-col">
            <h1>Thank you for downloading Ubuntu Server for cloud</h1>
            <p>Your download should start automatically. If it doesn&rsquo;t, <a href="http://releases.ubuntu.com/{{ request.GET.version }}/ubuntu-{{ request.GET.version }}-server-{{ request.GET.architecture.split|join:"+" }}.iso">download now</a>.</p>
        </div>
    </div>
    <div class="row row-grey">
        <div class="twelve-col no-margin-bottom equal-height">
            <div class="four-col one box box-highlight">
                <div class="four-col text-center">
                    <img alt="ubuntu one" src="{{ STATIC_URL }}img/pictograms/picto-pack/picto-startfirst-warmgrey.svg" width="113" height="113" />
                </div>
                <h3>Jumpstart Training</h3>
                <p>Two full days of technical training, covering Ubuntu, MAAS, Juju, Landscape, and OpenStack.</p>
                <p><a href="/cloud/training">Learn more about Jumpstart Training&nbsp;&rsaquo;</a></p>
            </div><!-- /.four-col -->
            <div class="four-col support box box-highlight">
                <div class="four-col text-center">
                    <img alt="ubuntu advantage" src="{{ STATIC_URL }}img/pictograms/picto-pack/picto-business-warmgrey.svg" width="113" height="113" />
                </div>
                <h3>Ubuntu Advantage for Cloud</h3>
                <p>All the commercial support your cloud deployment needs.</p>
                <p><a href="/management/ubuntu-advantage">Learn more about Ubuntu Advantage&nbsp;&rsaquo;</a></p>
            </div><!-- /.four-col -->
            <div class="four-col ask last-col box box-highlight">
                <div class="four-col text-center">
                    <img alt="ubuntu advantage" src="{{ STATIC_URL }}img/pictograms/picto-pack/picto-forum-warmgrey.svg" width="113" height="113" />
                </div>
                <h3>Ask Ubuntu</h3>
                <p>Need help? Ask your questions here.</p>
                <p><a href="http://askubuntu.com/questions/tagged/cloud" class="external">Get help</a></p>
            </div><!-- /.four-col -->
        </div><!-- /.row .row-box -->

    </div><!-- /.row .row-download -->
{% endblock content %}

{% block footer_extra %}
<script src="{{ STATIC_URL }}js/helpers.js"></script>

<script>
// Download file information
var defaultLocation = 'http://releases.ubuntu.com/'; // Default to releases.ubuntu.com
var version = '{{ request.GET.version }}';
var architecture = '{{ request.GET.architecture.split|join:"+" }}';

// Mirrors for this country
var mirrors = {{ mirror_list|safe }};

if (version && architecture) {
    // Report to Google Analytics
    YUI().use('event-base', function (Y) {
        Y.on('domready', function () {
            _gaq.push(['_trackEvent', 'Download', 'Downloaded', 'User downloaded Ubuntu (' + version + '-server-' + architecture + ')']);
        });
    });

    startDownload(mirrors, version, architecture, defaultLocation);
}

function startDownload(mirrors, version, architecture, defaultLocation) {
    // Select a random mirror from list
    var selectedMirror = chooseRandomMirror(mirrors);
    var downloadLocation = defaultLocation;

    // Build the download link
    if (selectedMirror && selectedMirror.link) {
        downloadLocation = selectedMirror.link;
    }
    var downloadLink = downloadLocation + version + '/ubuntu-' + version + '-server-' + architecture + '.iso';

    // Start download
    delayStartDownload(downloadLink, 3000);
}

/**
 * Kick off a download link
 * after a certain delay in milliseconds
 */
function delayStartDownload(downloadLink, delay) {
    window.setTimeout(
        function () { window.location.href = downloadLink; },
        delay
    )
}

/**
 * Choose randomly from a given list of mirrors
 * Weight the choice by the bandwidth of each mirror
 */
function chooseRandomMirror(mirrors) {
    var selectedMirror = null;

    // Calculate total bandwidth
    var totalBandwidth = 0;
    mirrors.forEach(function (mirror) {
        mirror.bandwidth = parseInt(mirror.bandwidth) ? parseInt(mirror.bandwidth) : 0;
        totalBandwidth += mirror.bandwidth;
    });

    // Random weight-point to download
    var downloadPoint = Math.floor(Math.random() * totalBandwidth);
    var weightPoint = 0;

    // Select a mirror based on weighting
    for (var mirrorIndex = 0; mirrorIndex < mirrors.length;mirrorIndex++) {
        var mirror = mirrors[mirrorIndex];
        weightPoint += mirror.bandwidth;

        // If this is the random point to download
        if (downloadPoint < weightPoint) {
            selectedMirror = mirror;
            break;
        }
    }

    return selectedMirror;
}
</script>

{% endblock footer_extra %}
